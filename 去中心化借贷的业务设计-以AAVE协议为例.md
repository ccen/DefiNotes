  本文梳理以太坊上AAVE借贷协议的业务模式，重点关注各参与方的行为及其影响，不涉及具体数值系统（如利率模型）、开发设计（如接口、模块划分）。  
  本文适合读者：有一定区块链基础，希望快速理解Defi核心业务逻辑。

___

### 必须的预备知识
- 以太坊区块链是可执行智能合约的去中心化账本
- 链上交易是一种具有原子性的事务
- ERC20代币合约可以发行自定义的数字货币（下文亦称代币），并通过以太坊记账
- 去中心化借贷合约，核心功能是(1)存储代币，(2)借出代币
- 闪电贷是一种无抵押数字货币借贷模式，数字货币的借入与归还在同一个交易内进行
- 去中心化自组织（DAO）是一种业务治理模式
- AAVE代币是AAVE项目组发行的代币，代币拥有者具有AAVE项目治理的投票权
- ChainLink预言机，可以将不同代币间的汇率，准实时传递到链上合约，供AAVE合约查询
- 动态利率的本息乘数因子计算技巧。如存款人甲在T0本金为¥1，T1本息合计¥1.2，T2本息合计¥1.56。则存款人乙在T1存入本金¥1，T2时本息合计为(¥1/1.2*1.56)=1.3
___

### AAVE参与者角色
- AAVE合约：部署在以太坊，可提供代币存储、借贷的合约。
- 代币存储方：向AAVE合约存入数字货币，动机为(1)获取利息收益，(2)存入的代币作为抵押物向AAVE借贷其他类型数字货币。
- 代币普通模式借方：以抵押物向AAVE借入数字货币。
- 代币闪电模式借方：无抵押物向AAVE借入数字货币。
- 清算人：监测AAVE借方的资产健康系数，当系数低于清算线时，可以向AAVE合约发起清算。动机为(1)以折扣获得借方的抵押物，(2)收获清算奖励。
- AAVE代币持有方：持有AAVE代币，可参与AAVE项目治理。

---

### 核心Defi逻辑
#### 向AAVE合约存入代币
  代币存储方发起交易事务，调用AAVE合约代币存储接口。  
  AAVE合约验证存储请求有效，根据该代币资产、负债池情况更新存贷利率。  
  AAVE合约完成资产归属转移。事务结束。  

#### 从AAVE合约提取代币
  代币存储方发起交易事务，调用AAVE合约代币提取接口。  
  AAVE合约根据存贷利率计算资方可取金额，检查AAVE合约的代币资金池余额，验证提取请求有效。  
  AAVE合约完成资产归属转移，更新存贷利率。事务结束。  

#### 从AAVE合约借入代币
  借方发起交易事务，调用AAVE合约代币借贷接口。  
  AAVE合约根据预言机合约提供的汇率，将借方所有抵押资产换算为ETH数量，检查AAVE合约资金池余额，检验借贷请求有效。  
  AAVE合约完成借贷资产归属转移，更新存贷利率。事务结束。  

#### 向AAVE合约归还代币
  借方发起交易事务，调用AAVE合约偿还债务接口。  
  AAVE合约根据存贷利率计算借方债务情况，执行资产偿还。  
  AAVE合约更新存贷利率。事务结束。  

#### 清算人发起针对某一借方的清算
  清算人通过对借贷状态的监测，发现某一借方的抵押资产与债务资产的比例低于清算线。  
  清算人发起交易事务，提供可用于偿还债务的资产，调用AAVE合约清算接口。  
  AAVE合约根据预言机提供的汇率，计算被清算人资产健康系数，验证清算请求有效性。  
  AAVE合约使用清算人提供的资产，部分偿还被清算人的债务，并将对应抵押代币及奖励归属至清算人。  
  AAVE更新存贷利率。事务结束。  
  
  清算是一个复杂的事务，以上只描述了核心逻辑。这里额外提出三个值得注意的细节。  
- 发起清算时，清算人仅能分别指定一种债务、抵押物的资产类型。  
借方抵押物可能是多种数字货币A、B，债务可能是多种数字货币C、D。清算人可选择提供代币C偿还债务，获得对应的抵押物代币A。
- 抵押物清算比例与借方资产健康系数相关。目前当健康系数高于95%时，清算人只能清算借方50%抵押物。当健康系数低于95%时，清算人可以清算借方全部抵押物。
- 如抵押物价值无法偿清所有债务，清算人的清算上限为抵押物价值。清算结束后，借方账户下无抵押物，只有债务。除非借方主动偿还，否则该债务永远不会消失，即为AAVE合约对应代币池坏账。

#### 以闪电贷模式从AAVE合约借入代币
  借方首先在以太坊部署贷款接收合约，该合约需要按AAVE标准提供execute接口。  
  借方发起交易事务，调用AAVE合约闪电贷接口。  
  AAVE合约根据请求，将代币资产转移至借方指定的贷款接收合约。  
  AAVE合约调用贷款接收合约execute接口，要求接口响应处理成功，否则事务失败，回滚事务。  
  借方的贷款接收合约，需要在execute接口被调用时，授权AAVE合约可提取闪电贷资产及手续费。  
  AAVE合约从贷款接收合约提取闪电贷资产及手续费，如提取失败，则事务失败，回滚事务。  
  如AAVE合约成功收回闪电贷资产及手续费，事务结束。  

#### 系统性风险
  前述AAVE合约在某些资产汇率剧烈波动时可能产生资产池坏账。当大规模坏账产生时，极端情况下AAVE合约管理的抵押物被全部清算，而总债务未偿清。在这种情况下，AAVE合约的存款方将无法提取本金利息。  
  为了在这种情况下能够补偿存款方，AAVE项目设计了Safety Module机制，在以太坊上另外部署了一个准备金合约。准备金合约接受AAVE代币持有者将AAVE代币锁定在合约内，锁定代币可以获得奖励，提取代币需要7天冷却期。  
  当系统性风险发生时，准备金合约锁定的AAVE代币有不超过30%用于补偿存款方。若该补偿无法覆盖存款方损失，将进行AAVE代币拍卖以筹集补偿金。  
  
  以上补偿方案不是通过智能合约的逻辑在链上执行，而是通过DAO模式。步骤为：
1. 在社区征集提案，AAVE代币持有者可以参与投票，投票权重为AAVE代币持有量。
2. 社区开发者根据提案开发提案合约，部署到以太坊区块链。
3. AAVE代币持有者在链上对提案投票投票，若满足投票同意门槛，提案合约将在链上被触发执行。
